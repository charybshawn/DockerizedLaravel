---
# Playbook for setting up a Laravel development server locally

- name: Configure Laravel development environment
  hosts: localhost
  connection: local
  become: yes
  gather_facts: yes
  
  vars:
    # Default values that can be overridden via command line
    default_php_version: "{{ default_php_version | default('8.1') }}"
    create_sample_site: "{{ create_sample_site | default('no') }}"
    install_adminer: "{{ install_adminer | default('yes') }}"
    verbose_mode: "{{ verbose_mode | default(false) }}"
    
    # Derived variables
    create_sample: "{{ create_sample_site | lower == 'yes' }}"
    current_user: "{{ lookup('env', 'SUDO_USER') | default(lookup('env', 'USER'), true) }}"
    sample_site_name: "{{ sample_site_name | default('laravel') }}"
    sample_site_php_version: "{{ default_php_version }}"
    adminer_enabled: "{{ install_adminer | lower == 'yes' }}"
    
    # Database flags - these will be set after the prompt
    install_mysql: false
    install_postgres: false
    install_sqlite: false
      
  tasks:
    - name: Display current user
      debug:
        msg: "Setting up Laravel environment for user: {{ current_user }}"
      when: verbose_mode | bool

    - name: Set initial variables
      set_fact:
        db_systems: "{{ db_systems | default('') }}"
        mysql_root_password: "{{ mysql_root_password | default('') }}"
        postgres_password: "{{ postgres_password | default('') }}"
        adminer_password: "{{ adminer_password | default('') }}"
        adminer_password_final: "{{ adminer_password | default('admin') }}"

    - name: Prompt for missing required variables
      block:
        - name: Prompt for database systems if not provided
          pause:
            prompt: |
              Choose database systems (space-separated)
              Available options: mysql postgres sqlite
              Examples:
              - mysql postgres    (for MySQL and PostgreSQL)
              - mysql sqlite      (for MySQL and SQLite)
              - postgres sqlite   (for PostgreSQL and SQLite)
              - mysql postgres sqlite  (for all three)
            echo: yes
          register: db_systems_prompt
          when: db_systems == ''
          
        - name: Set database systems from prompt
          set_fact:
            db_systems: "{{ db_systems_prompt.user_input }}"
            install_mysql: "{{ 'mysql' in db_systems_prompt.user_input.split() }}"
            install_postgres: "{{ 'postgres' in db_systems_prompt.user_input.split() }}"
            install_sqlite: "{{ 'sqlite' in db_systems_prompt.user_input.split() }}"
          when: db_systems == '' and db_systems_prompt.user_input is defined
          
        - name: Set database flags if db_systems is already set
          set_fact:
            install_mysql: "{{ 'mysql' in db_systems.split() }}"
            install_postgres: "{{ 'postgres' in db_systems.split() }}"
            install_sqlite: "{{ 'sqlite' in db_systems.split() }}"
          when: db_systems != ''
          
        - name: Display selected database systems
          debug:
            msg: |
              Selected database systems:
              - MySQL: {{ install_mysql | bool }}
              - PostgreSQL: {{ install_postgres | bool }}
              - SQLite: {{ install_sqlite | bool }}
          when: verbose_mode | bool
          
        - name: Prompt for MySQL password if needed
          pause:
            prompt: "MySQL root password"
            echo: no
          register: mysql_prompt
          when: install_mysql | bool and mysql_root_password == ''
          
        - name: Set MySQL root password from prompt
          set_fact:
            mysql_root_password: "{{ mysql_prompt.user_input }}"
          when: install_mysql | bool and mysql_root_password == '' and mysql_prompt.user_input is defined
          
        - name: Prompt for PostgreSQL password if needed
          pause:
            prompt: "PostgreSQL postgres user password"
            echo: no
          register: postgres_prompt
          when: install_postgres | bool and postgres_password == ''
          
        - name: Set PostgreSQL password from prompt
          set_fact:
            postgres_password: "{{ postgres_prompt.user_input }}"
          when: install_postgres | bool and postgres_password == '' and postgres_prompt.user_input is defined
          
        - name: Set initial PHP versions
          set_fact:
            php_versions: "8.1"
            php_version_list: ["8.1"]
          when: php_versions is not defined

        - name: Prompt for PHP versions if not provided
          pause:
            prompt: "PHP versions to install (space-separated, e.g., '8.1 8.2 8.3')"
            echo: yes
          register: php_versions_prompt
          when: php_versions is not defined
          
        - name: Set PHP versions from prompt
          set_fact:
            php_versions: "{{ php_versions_prompt.user_input }}"
            php_version_list: "{{ php_versions_prompt.user_input.split() }}"
          when: php_versions_prompt.user_input is defined
          
        - name: Prompt for default PHP version if not provided
          pause:
            prompt: "Default PHP version to use"
            echo: yes
          register: default_php_prompt
          when: not default_php_version
          
        - name: Set default PHP version from prompt
          set_fact:
            default_php_version: "{{ default_php_prompt.user_input }}"
          when: not default_php_version and default_php_prompt.user_input is defined
          
        - name: Prompt for sample site creation if not provided
          pause:
            prompt: "Create a sample Laravel site? (yes/no)"
            echo: yes
          register: sample_site_prompt
          when: not create_sample_site
          
        - name: Set sample site creation from prompt
          set_fact:
            create_sample_site: "{{ sample_site_prompt.user_input }}"
            create_sample: "{{ sample_site_prompt.user_input | lower == 'yes' }}"
          when: not create_sample_site and sample_site_prompt.user_input is defined
          
        - name: Prompt for Adminer installation if not provided
          pause:
            prompt: "Install Adminer database manager? (yes/no)"
            echo: yes
          register: adminer_prompt
          when: not install_adminer
          
        - name: Set Adminer installation from prompt
          set_fact:
            install_adminer: "{{ adminer_prompt.user_input }}"
            adminer_enabled: "{{ adminer_prompt.user_input | lower == 'yes' }}"
          when: not install_adminer and adminer_prompt.user_input is defined
          
        - name: Prompt for Adminer password if not provided
          pause:
            prompt: "Adminer admin password (leave blank to use default)"
            echo: no
          register: adminer_pass_prompt
          when: not adminer_password and adminer_enabled | bool
          
        - name: Set Adminer password from prompt
          set_fact:
            adminer_password: "{{ adminer_pass_prompt.user_input }}"
            adminer_password_final: "{{ adminer_pass_prompt.user_input | default('admin') }}"
          when: not adminer_password and adminer_enabled | bool and adminer_pass_prompt.user_input is defined
          
    - name: Display PHP versions being installed
      debug:
        msg: "Installing PHP versions: {{ php_version_list | join(', ') }}"
      when: verbose_mode | bool
      
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      
    - name: Install essential packages
      apt:
        name:
          - curl
          - wget
          - git
          - zip
          - unzip
          - acl
          - htop
          - vim
          - python3-pip
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - cron
        state: present
      when: ansible_os_family == "Debian"
      
    # PHP Installation
    - name: Add PHP repository
      apt_repository:
        repo: ppa:ondrej/php
        state: present
      when: ansible_distribution == "Ubuntu"
    
    - name: Install all requested PHP versions
      block:
        - name: Install PHP and extensions for each version
          apt:
            name:
              - php{{ php_version }}
              - php{{ php_version }}-fpm
              - php{{ php_version }}-cli
              - php{{ php_version }}-common
              - php{{ php_version }}-mysql
              - php{{ php_version }}-pgsql
              - php{{ php_version }}-mbstring
              - php{{ php_version }}-xml
              - php{{ php_version }}-curl
              - php{{ php_version }}-zip
              - php{{ php_version }}-gd
              - php{{ php_version }}-intl
              - php{{ php_version }}-bcmath
              - php{{ php_version }}-soap
              - php{{ php_version }}-xdebug
              - php{{ php_version }}-redis
            state: present
          loop: "{{ php_version_list }}"
          loop_control:
            loop_var: php_version
          when: ansible_os_family == "Debian"
          
        - name: Set default PHP version alternative priority
          shell: update-alternatives --set php /usr/bin/php{{ default_php_version }}
          ignore_errors: yes
          
        - name: Configure PHP-FPM for better performance for each version
          lineinfile:
            path: /etc/php/{{ item.0 }}/fpm/pool.d/www.conf
            regexp: '^;?{{ item.1.key }} ='
            line: '{{ item.1.key }} = {{ item.1.value }}'
          loop: "{{ php_version_list | product([
              { 'key': 'pm.max_children', 'value': '50' },
              { 'key': 'pm.start_servers', 'value': '5' },
              { 'key': 'pm.min_spare_servers', 'value': '5' },
              { 'key': 'pm.max_spare_servers', 'value': '35' }
            ]) | list }}"
          loop_control:
            loop_var: item
          notify: "restart php{{ item.0 }}-fpm"
          
      when: php_version_list | length > 0
      
    # Nginx Installation
    - name: Install Nginx
      apt:
        name: nginx
        state: present
      when: ansible_os_family == "Debian"
      
    - name: Start and enable Nginx
      service:
        name: nginx
        state: started
        enabled: yes
        
    # Ensure cron is running
    - name: Start and enable cron service
      service:
        name: cron
        state: started
        enabled: yes
      when: ansible_os_family == "Debian"
      
    # MySQL Installation
    - name: Install MySQL
      apt:
        name:
          - mysql-server
          - mysql-client
        state: present
      when: install_mysql | bool and ansible_os_family == "Debian"
      
    - name: Start and enable MySQL
      service:
        name: mysql
        state: started
        enabled: yes
      when: install_mysql | bool
        
    - name: Set MySQL root password
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        login_unix_socket: /var/run/mysqld/mysqld.sock
        host_all: yes
        state: present
      no_log: true
      when: install_mysql | bool
      
    - name: Create .my.cnf file for root
      copy:
        dest: /root/.my.cnf
        content: |
          [client]
          user=root
          password={{ mysql_root_password }}
        mode: '0600'
      no_log: true
      when: install_mysql | bool
      
    # PostgreSQL Installation
    - name: Install PostgreSQL
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - libpq-dev
        state: present
      when: install_postgres | bool and ansible_os_family == "Debian"
      
    - name: Start and enable PostgreSQL
      service:
        name: postgresql
        state: started
        enabled: yes
      when: install_postgres | bool
        
    - name: Set PostgreSQL postgres user password
      become: yes
      become_user: postgres
      postgresql_user:
        name: postgres
        password: "{{ postgres_password }}"
      no_log: true
      when: install_postgres | bool
      
    # SQLite Installation
    - name: Install SQLite
      apt:
        name: sqlite3
        state: present
      when: install_sqlite | bool and ansible_os_family == "Debian"
      
    # Node.js Installation
    - name: Set Node.js version
      set_fact:
        node_version: "{{ node_version | default('18') }}"
      
    - name: Install Node.js repository 
      shell: curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | bash -
      when: ansible_os_family == "Debian"
      
    - name: Install Node.js
      apt:
        name: nodejs
        state: present
      when: ansible_os_family == "Debian"
      
    - name: Install npm packages globally
      npm:
        name: "{{ item }}"
        global: yes
      loop:
        - npm
        - yarn
        
    # Composer Installation
    - name: Download Composer installer
      get_url:
        url: https://getcomposer.org/installer
        dest: /tmp/composer-setup.php
        mode: '0755'
        
    - name: Install Composer globally
      shell: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
      args:
        creates: /usr/local/bin/composer
        
    - name: Remove Composer installer
      file:
        path: /tmp/composer-setup.php
        state: absent
        
    # Laravel setup
    - name: Setup Laravel development environment
      block:
        - name: Create web directory for Laravel site
          file:
            path: "/var/www/{{ sample_site_name }}"
            state: directory
            owner: "{{ current_user }}"
            group: www-data
            mode: '0755'
          
        - name: Install Laravel using Composer
          become: yes
          become_user: "{{ current_user }}"
          shell: composer create-project laravel/laravel /var/www/{{ sample_site_name }} --no-interaction
          args:
            creates: "/var/www/{{ sample_site_name }}/artisan"
          
        - name: Set proper permissions for Laravel directories
          file:
            path: "/var/www/{{ sample_site_name }}/{{ item }}"
            state: directory
            owner: "{{ current_user }}"
            group: www-data
            mode: '0775'
            recurse: yes
          loop:
            - storage
            - bootstrap/cache
          
        - name: Configure Laravel database connections
          template:
            src: ../templates/laravel_database.j2
            dest: "/var/www/{{ sample_site_name }}/config/database.php"
            owner: "{{ current_user }}"
            group: www-data
            mode: '0644'
          vars:
            mysql_enabled: "{{ install_mysql | bool }}"
            postgres_enabled: "{{ install_postgres | bool }}"
            sqlite_enabled: "{{ install_sqlite | bool }}"
            mysql_password: "{{ mysql_root_password }}"
            postgres_password: "{{ postgres_password }}"
          
        - name: Create Nginx server block for Laravel
          template:
            src: ../templates/laravel_nginx.j2
            dest: /etc/nginx/sites-available/{{ sample_site_name }}
            owner: root
            group: root
            mode: '0644'
          vars:
            server_name: "{{ sample_site_name }}.local"
            root_directory: "/var/www/{{ sample_site_name }}/public"
            php_version: "{{ sample_site_php_version }}"
          
        - name: Enable Nginx server block
          file:
            src: /etc/nginx/sites-available/{{ sample_site_name }}
            dest: /etc/nginx/sites-enabled/{{ sample_site_name }}
            state: link
          
        - name: Add hostname to /etc/hosts
          lineinfile:
            path: /etc/hosts
            line: "127.0.0.1 {{ sample_site_name }}.local"
            state: present
          
        - name: Restart Nginx
          service:
            name: nginx
            state: restarted
            
      when: create_sample
        
    # Get service status for summary
    - name: Get Nginx status
      command: systemctl is-active nginx
      register: nginx_status
      changed_when: false
      failed_when: false
      
    - name: Get MySQL status
      command: systemctl is-active mysql
      register: mysql_status
      changed_when: false
      failed_when: false
      when: install_mysql | bool
      
    - name: Get PostgreSQL status
      command: systemctl is-active postgresql
      register: postgresql_status
      changed_when: false
      failed_when: false
      when: install_postgres | bool
    
    - name: Get PHP-FPM status for each version
      command: "systemctl is-active php{{ php_version }}-fpm"
      register: php_status_results
      changed_when: false
      failed_when: false
      loop: "{{ php_version_list }}"
      loop_control:
        loop_var: php_version
      
    - name: Get server IP
      command: hostname -I
      register: server_ip
      changed_when: false
      
    # Install Adminer if requested
    - name: Generate password hash for Adminer
      shell: openssl passwd -apr1 "{{ adminer_password_final }}"
      register: adminer_password_hash_result
      when: adminer_enabled | bool and adminer_password_final != ""
      no_log: true
      
    - name: Install and configure Adminer
      include_role:
        name: adminer
      vars:
        adminer_domain: "db.{{ ansible_hostname }}.local"
        adminer_user: "admin"
        adminer_password_hash: "{{ adminer_password_hash_result.stdout | default('') }}"
        php_version: "{{ default_php_version }}"
      when: adminer_enabled | bool
      
    - name: Add Adminer domain to /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "127.0.0.1 db.{{ ansible_hostname }}.local"
        state: present
      when: adminer_enabled | bool
      
    # Display Adminer info in summary if enabled
    - name: Include Adminer info in summary if enabled
      set_fact:
        adminer_info: |
          
          üóÑÔ∏è Database Management:
            - Adminer URL: http://db.{{ ansible_hostname }}.local:9000/
            - Username: admin
            - Password: {{ adminer_password_final }}
            - Direct access: http://{{ server_ip.stdout.split()[0] }}:9000/
            - Status: {{ 'Reachable' if nginx_status.stdout == 'active' else 'Not reachable' }}
      when: adminer_enabled | bool
      no_log: true
      
    - name: Include empty Adminer info if disabled
      set_fact:
        adminer_info: ""
      when: not adminer_enabled | bool
      
    # Display summary
    - name: Display environment summary
      debug:
        msg: |
          {% if verbose_mode | bool %}
          üìä Environment Setup Summary:
          ====================================================
          üîß Services Status:
            - Nginx: {{ nginx_status.stdout }}
            {% if install_mysql | bool %}
            - MySQL: {{ mysql_status.stdout }}
            {% endif %}
            {% if install_postgres | bool %}
            - PostgreSQL: {{ postgresql_status.stdout }}
            {% endif %}
            {% if install_sqlite | bool %}
            - SQLite: Installed
            {% endif %}
            {% for result in php_status_results.results %}
            - PHP{{ php_version_list[loop.index0] }}-FPM: {{ result.stdout }}
            {% endfor %}
          
          üåê Network Information:
            - Server IP: {{ server_ip.stdout.split()[0] }}
            - Web Port: 80 (HTTP)
            {% if install_mysql | bool %}
            - MySQL Port: 3306
            {% endif %}
            {% if install_postgres | bool %}
            - PostgreSQL Port: 5432
            {% endif %}
          {{ adminer_info }}
          {% if create_sample %}
          üöÄ Sample Laravel Site:
            - Site: {{ sample_site_name }}
            - URL: http://{{ server_ip.stdout.split()[0] }}/
            - URL: http://{{ sample_site_name }}.local/ (add to your hosts file)
            - Path: /var/www/{{ sample_site_name }}/
            - PHP Version: {{ sample_site_php_version }}
            - Database: {{ db_systems }}
          {% else %}
          ‚ÑπÔ∏è No sample site was created during setup.
            - Run './setup-site.sh' to create a new Laravel site
          {% endif %}
          
          ====================================================
          Your Laravel development environment is ready!
          {% else %}
          ‚úÖ Laravel development environment setup complete!
          {% if adminer_enabled | bool %}
          üìä Database Management: http://db.{{ ansible_hostname }}.local:9000/
          {% endif %}
          {% if create_sample %}
          üöÄ Sample site: http://{{ sample_site_name }}.local/
          {% endif %}
          {% endif %}
      

  handlers:
    - name: restart nginx
      service:
        name: nginx
        state: restarted
    
    - name: restart php8.1-fpm
      service:
        name: php8.1-fpm
        state: restarted
        
    - name: restart php8.2-fpm
      service:
        name: php8.2-fpm
        state: restarted
        
    - name: restart php8.3-fpm
      service:
        name: php8.3-fpm
        state: restarted 